package serial;

import com.fazecast.jSerialComm.SerialPort;

import tools.TimeWatch;

public class BlockingSerial {

	private String buffer = "";
	
	public String sendAwait(SerialPort comPort, String data, int timeout)
	{
		comPort.setBaudRate(115200);
		comPort.openPort();
		comPort.setComPortTimeouts(SerialPort.TIMEOUT_READ_SEMI_BLOCKING, timeout, 0);

		comPort.writeBytes(data.getBytes(), data.length());
		
		TimeWatch watch = TimeWatch.start();
		boolean doMainLoop = true;
		
		
		try {
		   while (doMainLoop)
		   {		   
		      while (comPort.bytesAvailable() == 0)
		      {
		         Thread.sleep(20);
		         if(watch.time() > timeout)
			    	  break;
		      }

		      byte[] readBuffer = new byte[comPort.bytesAvailable()];
		      comPort.readBytes(readBuffer, readBuffer.length);
		      buffer += new String(readBuffer);

		      if((buffer.contains("<") && buffer.contains(">")) || buffer.contains("\n"))
		      {
		    	  comPort.closePort();
		    	  return buffer;
		      }
		      
		      if(watch.time() > timeout)
		    	  break;
		   }
		} catch (Exception e) { e.printStackTrace(); }
		
		comPort.closePort();
		return buffer;
	}
}
