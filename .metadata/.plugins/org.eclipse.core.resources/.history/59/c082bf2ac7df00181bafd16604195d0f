package controllers;

import java.io.IOException;
import java.text.DecimalFormat;

import com.fazecast.jSerialComm.SerialPort;

import application.Global;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.ProgressBar;
import javafx.scene.layout.VBox;
import mrParser.Command;
import mrParser.Parser;
import serial.BlockingSerial;
import serial.SerialConnection;

public class HomeScreenController {

	private SerialPort dev;
	private BlockingSerial bs = new BlockingSerial();
	private Global g = new Global();

	@FXML
	private VBox VBoxTitles;

	@FXML
	private Label labelTitle;

	@FXML
	private Label labelContent;

	@FXML
	private Label labelDevName;

	@FXML
	private Label labelDevID;

	@FXML
	private Label labelDevMemory;

	@FXML
	private ProgressBar progressBarMem;

	@FXML
	void onActionAddNote() {

	}

	@FXML
	void onaActionDeleteNote() {

	}

	@FXML
	void onaActionEditNote() {

	}

	@FXML
	void onaActionRenameNote() {

	}

	@FXML
	public void initialize() {
		labelTitle.setText("");
		labelContent.setText("");
	}

	public void openNote(String notePath) {
		Command notes = Parser.parse(bs.sendAwait(dev, "<read:" + notePath + ">", 10000));
		if (notes.isValid()) {
			if (notes.getCommand().contains("read")) {
				labelTitle.setText(notePath);
				labelContent.setText(notes.getProp().get(0));
			} else
				System.out
						.println("Err: Unexpected command: " + notes.getCommand() + ", while loading note " + notePath);
		}
	}

	public void setDevice(SerialPort dev) {
		this.dev = dev;

		Command c = Parser.parse(bs.sendAwait(dev, "<open:/t4.txt>", 100));
		if (c.getCommand().contains("ok")) {
			for (int i = 0; i < 1000; i++) {
				c = Parser.parse(bs.sendAwait(dev,
						"<<append:Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam a laoreet justo, et rutrum nisl. Integer sapien risus, iaculis eget elementum eu, dignissim vel sem. Nulla eleifend in libero id consectetur. Quisque urna purus, finibus in lacus vitae, consectetur dapibus elit. Vivamus vitae eros nec ante facilisis consequat vitae a dui. Donec sed nisi risus. Duis vitae nunc varius, dapibus leo in, venenatis mi. Fusce egestas sapien orci, a sagittis turpis facilisis ac. Aenean sollicitudin ornare massa. Integer euismod arcu eros, vel vestibulum metus pellentesque at.\r\n"
								+ "\r\n"
								+ "Proin accumsan ipsum est, quis fermentum felis condimentum et. Vestibulum rhoncus risus at lorem sodales blandit. Sed ut mauris odio. Pellentesque bibendum pellentesque est, et pulvinar odio mollis vel. Pellentesque eros justo, varius id tortor at, bibendum elementum diam. In sollicitudin ligula eget lectus tristique placerat. Fusce a nibh tempus, tempor ipsum at, elementum metus. Integer at venenatis nibh, non consectetur enim. Quisque lacinia dui sed felis mattis, eget consequat nisi molestie. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Fusce nunc sapien, imperdiet dapibus tortor at, tristique vulputate ipsum. Vestibulum nec dolor gravida, pellentesque urna non, mollis enim.\r\n"
								+ "\r\n"
								+ "Ut ornare felis et ipsum mattis feugiat. Suspendisse facilisis fringilla quam nec porttitor. Sed libero nunc, tempor ut aliquet et, tristique vitae tortor. Phasellus erat dolor, ultricies non tortor a, varius convallis arcu. Curabitur vulputate ut nulla iaculis maximus. Quisque feugiat ipsum efficitur justo tincidunt fringilla. Proin accumsan elit vitae magna mattis facilisis. Duis libero leo, elementum eu laoreet sed, congue et massa. Aenean dictum lobortis arcu. Vestibulum quis lacus scelerisque, fringilla eros sed, egestas orci.\r\n"
								+ "\r\n"
								+ "Pellentesque iaculis ex sed lacus suscipit mollis. Morbi sed sapien odio. Nunc non imperdiet libero. Curabitur id eleifend lectus. Phasellus id viverra nisl. Sed ex lacus, sodales vitae elit ac, scelerisque finibus leo. Vestibulum ex mauris, aliquet ac nibh sed, lacinia fringilla nisi. Fusce vestibulum est ac turpis elementum, at aliquet nibh euismod. Quisque vitae dictum enim. Vivamus tristique tempor aliquet. Quisque sollicitudin erat quis fringilla semper. Mauris cursus dolor orci, sed iaculis erat consequat a. Nulla sed neque ut lacus commodo facilisis.\r\n"
								+ "\r\n"
								+ "Aliquam a metus vulputate, pellentesque massa vitae, rutrum augue. Pellentesque volutpat lacinia enim, eu molestie neque ultrices id. Mauris et urna quis quam luctus hendrerit id id quam. Mauris congue accumsan diam et tincidunt. Nulla non interdum velit, ut pretium est. Mauris at tellus nibh. Phasellus venenatis dapibus metus, nec cursus justo. Mauris euismod neque eu eros tristique tempus. Morbi non nisi eget risus finibus condimentum. Cras suscipit libero quis diam tristique pellentesque. Fusce felis nisl, scelerisque eu enim eget, iaculis sollicitudin sem. Quisque volutpat neque sed quam condimentum sagittis. Maecenas non nulla id dolor ornare dictum sit amet mollis ipsum.\r\n"
								+ "\r\n"
								+ "Nullam at dui nisl. Nulla sodales quis ipsum vitae eleifend. Mauris pellentesque iaculis ante, nec vestibulum leo maximus eu. Pellentesque lacinia scelerisque massa id vehicula. Aliquam erat volutpat. Ut dapibus, ante ut porta egestas, ante sapien sollicitudin metus, eu ullamcorper libero erat nec arcu. Suspendisse mollis risus vel est vehicula egestas.\r\n"
								+ "\r\n"
								+ "Aenean a eros ac ligula luctus ultricies. Etiam neque augue, consequat sit amet vestibulum vitae, efficitur vitae diam. Sed accumsan, dolor vitae tempor sollicitudin, neque sem suscipit lacus, non eleifend enim nibh consequat dolor. In eu libero et dui porta sollicitudin. Nunc lobortis elementum leo et viverra. Integer dapibus et lorem eu consequat. Phasellus quam neque, fermentum vel malesuada non, mattis vel velit. Duis tempor sodales condimentum. Ut sem mauris, dictum ac dapibus sit amet, viverra nec justo. Phasellus vitae vestibulum nisi. Aenean quis libero vulputate orci vestibulum eleifend. Duis est magna, facilisis a turpis non, gravida mattis urna. Vivamus finibus egestas mi, porta blandit leo auctor sed. Etiam porta ante quis urna pellentesque semper.\r\n"
								+ "\r\n"
								+ "Sed interdum massa at eros fringilla accumsan. Aliquam id augue pellentesque, varius ex nec, vehicula mauris. Aenean sit amet turpis non eros tincidunt ullamcorper. Suspendisse ut semper tortor. Quisque lacinia aliquet auctor. Donec lobortis at nibh non sodales. Cras in pulvinar est. Nunc interdum facilisis nunc vel dapibus. Morbi ac semper augue. Donec congue pellentesque turpis vel molestie. Sed ut consequat lacus, eget tincidunt dolor. Aenean quis est nec mi sollicitudin volutpat eu vel justo.\r\n"
								+ "\r\n"
								+ "Curabitur ut facilisis massa, sit amet viverra turpis. Integer placerat nibh dictum consectetur feugiat. Fusce suscipit purus sit amet sapien vulputate consequat. Sed feugiat nisl quis libero sagittis interdum. Vivamus enim eros, ornare eget ultrices at, facilisis eget velit. In congue iaculis nisi a aliquam. Donec feugiat, quam non dapibus accumsan, turpis tellus aliquet odio, ac aliquam urna odio elementum nunc. Nam malesuada vitae sapien eget egestas. Proin in purus eu enim fringilla dapibus sit amet id ante. Ut quis nunc quis quam venenatis euismod vel nec massa. Vestibulum vestibulum mi at velit porttitor, nec malesuada justo pulvinar. Mauris eu nisi tellus. Curabitur sit amet tortor nunc. Integer massa turpis, mattis non blandit sit amet, accumsan eget ex. Etiam sed eros urna.\r\n"
								+ "\r\n"
								+ "Integer condimentum quis leo id suscipit. Cras facilisis sapien vel risus auctor, non aliquam justo finibus. Ut magna sem, cursus accumsan massa id, cursus dignissim odio. Aliquam eget nisi eleifend, consequat nisl at, dictum erat. Donec et dictum nisl, nec consectetur velit. Maecenas imperdiet justo id ipsum sollicitudin sollicitudin. Maecenas ut vulputate metus. Fusce eu magna dui. Sed hendrerit imperdiet quam, eu semper ligula semper vitae. Nam eget est ac orci efficitur pulvinar id vel nunc. Vestibulum magna nunc, interdum vitae nunc ut, egestas volutpat mi.\r\n"
								+ "\r\n"
								+ "Praesent convallis magna at nibh posuere, nec commodo sem euismod. In hac habitasse platea dictumst. Praesent non quam dolor. Etiam fermentum fringilla ex et euismod. Aenean ut nisl sodales, efficitur mi ut, imperdiet lorem. Aliquam ac imperdiet tortor, a posuere neque. Phasellus consequat sed risus sit amet fermentum. Mauris eu augue mauris. Etiam neque diam, venenatis a dui ultricies, laoreet bibendum est. Sed elementum feugiat orci, eu aliquam felis tincidunt id. Etiam egestas gravida neque, vel pharetra eros rutrum et. Nam luctus lacinia nisl. Vestibulum malesuada lectus nec massa faucibus blandit sed ut nisl. Nullam a blandit odio.\r\n"
								+ "\r\n"
								+ "Nullam vel lacinia lorem. Nunc purus erat, venenatis non turpis suscipit, accumsan dictum lacus. Vivamus imperdiet nibh sed eros finibus, et accumsan tellus dapibus. Suspendisse nisl odio, euismod quis elementum a, tempor porttitor justo. Aenean sodales, lorem hendrerit consectetur convallis, est justo tempor risus, tincidunt pellentesque purus sem in augue. Nullam bibendum, velit id sollicitudin tristique, dolor tortor rhoncus augue, non facilisis nulla velit quis mi. Cras id ex sit amet nulla congue fringilla sit amet ut massa.\r\n"
								+ "\r\n"
								+ "Nulla malesuada sapien id mauris posuere dapibus. Fusce maximus blandit molestie. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Curabitur quis lacinia lacus, at ullamcorper lacus. Integer ultricies lacinia eleifend. Nam ornare mauris congue pulvinar rhoncus. Nullam mi urna, faucibus maximus luctus vel, efficitur a leo. Proin rhoncus cursus faucibus. Sed aliquet augue id enim aliquam, nec tristique augue venenatis. Curabitur rutrum dolor condimentum, rhoncus diam aliquam, fermentum erat.\r\n"
								+ "\r\n"
								+ "Integer sodales pellentesque dolor, in ullamcorper mauris fringilla eget. Nunc eu molestie nibh, et vulputate nibh. Ut volutpat nisl ultricies, semper justo quis, egestas sapien. Nullam purus nibh, luctus efficitur turpis a, posuere cursus nisi. Curabitur a vestibulum ligula. Aliquam dignissim, neque nec pharetra dignissim, urna lacus porttitor elit, id bibendum justo diam ac enim. Aenean sed.>>",
						1000));
				System.out.println(c.getCommand());
			}
		} else
			System.out.println(c.getCommand());

		c = Parser.parse(bs.sendAwait(dev, "<close>", 100));
		System.out.println(c.getCommand());

		Command notes = Parser.parse(bs.sendAwait(dev, "<list>", 2000));
		if (notes.isValid()) {
			if (notes.getCommand().contains("list")) {
				VBoxTitles.getChildren().clear();
				for (String note : notes.getProp()) {

					FXMLLoader ld = g.getResLoader("TitleNode");
					Label newB;
					try {
						newB = ld.load();

						TitleNodeController tnc = ld.getController();
						tnc.setName(note);
						tnc.setHSC(this);

						VBoxTitles.getChildren().add(newB);
					} catch (IOException e) {
						e.printStackTrace();
					}
				}
			} else
				System.out.println("Err: Unexpected command: " + notes.getCommand() + ", while loading notes");
		}

		Command deviceInfo = Parser.parse(bs.sendAwait(dev, "<getInfo>", 2000));
		if (deviceInfo.isValid()) {
			if (deviceInfo.getCommand().contains("devInfo")) {
				labelDevName.setText(deviceInfo.getProp().get(0));
				labelDevID.setText(deviceInfo.getProp().get(1));
			} else
				System.out
						.println("Err: Unexpected command: " + deviceInfo.getCommand() + ", while loading deviceInfo");
		}

		Command memInfo = Parser.parse(bs.sendAwait(dev, "<getMemInfo>", 2000));
		if (memInfo.isValid()) {
			if (memInfo.getCommand().contains("memInfo")) {
				DecimalFormat df = new DecimalFormat("0.##");
				int totalBytes = Integer.parseInt(memInfo.getProp().get(0));
				int usedBytes = Integer.parseInt(memInfo.getProp().get(1));

				double a, b;
				a = usedBytes / 1024.0;
				b = (totalBytes / 1024.0);

				String out = "";
				out += df.format(a);
				out += "/";
				out += df.format(b);

				labelDevMemory.setText(out);

				double progress = usedBytes / totalBytes;

				progressBarMem.setProgress(progress);

			} else
				System.out
						.println("Err: Unexpected command: " + memInfo.getCommand() + ", while loading deviceMemInfo");
		}
	}
}
