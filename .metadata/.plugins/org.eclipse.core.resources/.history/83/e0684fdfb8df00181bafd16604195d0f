package serial;

import com.fazecast.jSerialComm.SerialPort;

import tools.TimeWatch;

public class BlockingSerial {

	private String buffer = "";
	
	public String sendAwait(SerialPort device, String data, int timeout)
	{
		SerialPort comPort = device;
		comPort.setBaudRate(115200);
		comPort.openPort();
		comPort.setComPortTimeouts(SerialPort.TIMEOUT_READ_SEMI_BLOCKING, timeout/2, 0);
		
		TimeWatch watch = TimeWatch.start();
		
		try {
		   while (true)
		   {		   
		      while (comPort.bytesAvailable() == 0)
		         Thread.sleep(20);

		      byte[] readBuffer = new byte[comPort.bytesAvailable()];
		      int numRead = comPort.readBytes(readBuffer, readBuffer.length);
		      buffer += new String(readBuffer);
		      
		      if((buffer.contains("<") && buffer.contains(">")) || buffer.contains("\n"))
		      {
		    	  comPort.closePort();
		    	  return buffer;
		      }
		      
		      if(watch.time() > timeout)
		    	  break;
		   }
		} catch (Exception e) { e.printStackTrace(); }
		comPort.closePort();
	}
	
	return buffer;
}
